<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aegis â†’ NextDNS Importer</title>
    <style>
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            max-width: 600px;
            margin: 40px auto;
            padding: 20px;
            background: #f8f9fa;
            color: #1a1a1a;
        }
        h1 { color: #2563eb; margin-bottom: 8px; }
        .subtitle { color: #6b7280; margin-bottom: 24px; }
        label { display: block; margin-top: 16px; color: #374151; font-size: 14px; font-weight: 500; }
        input, select {
            width: 100%;
            padding: 12px;
            margin-top: 4px;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            background: white;
            color: #1a1a1a;
            font-size: 16px;
        }
        input:focus, select:focus { border-color: #2563eb; outline: none; box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
        button {
            width: 100%;
            padding: 14px;
            margin-top: 24px;
            border: none;
            border-radius: 6px;
            background: #2563eb;
            color: white;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
        }
        button:hover { background: #1d4ed8; }
        button:disabled { background: #9ca3af; cursor: not-allowed; }
        .progress {
            margin-top: 24px;
            padding: 16px;
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 6px;
            display: none;
        }
        .progress-bar {
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin: 12px 0;
        }
        .progress-fill {
            height: 100%;
            background: #2563eb;
            width: 0%;
            transition: width 0.3s;
        }
        .stats { font-size: 14px; color: #6b7280; }
        .stats span { color: #1a1a1a; font-weight: 500; }
        .error { color: #dc2626; margin-top: 12px; }
        .success { color: #16a34a; margin-top: 12px; }
        .help { font-size: 13px; color: #6b7280; margin-top: 4px; }
        a { color: #2563eb; }
        .privacy {
            background: #ecfdf5;
            border: 1px solid #10b981;
            padding: 10px 12px;
            border-radius: 6px;
            font-size: 13px;
            color: #065f46;
            margin-bottom: 8px;
        }
        .warning {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            padding: 12px;
            border-radius: 6px;
            margin-top: 24px;
            font-size: 14px;
            color: #92400e;
        }
    </style>
</head>
<body>
    <h1>Aegis â†’ NextDNS</h1>
    <p class="subtitle">Import the Aegis blocklist to your NextDNS denylist</p>
    <p class="privacy">ðŸ”’ <strong>Privacy:</strong> Your credentials are never stored. This tool runs entirely in your browser and sends requests directly to NextDNS. One-time import only.</p>

    <label>NextDNS API Key</label>
    <input type="password" id="apiKey" placeholder="xxxxxxxxxxxxxxxxxxxxxxxx">
    <p class="help">
        <strong>How to get your API key:</strong><br>
        1. Go to <a href="https://my.nextdns.io/account" target="_blank">my.nextdns.io/account</a><br>
        2. Scroll down to "API"<br>
        3. Click "Create new API key" or copy your existing key
    </p>

    <label>Config ID (for your Kids profile)</label>
    <input type="text" id="configId" placeholder="abc123">
    <p class="help">
        <strong>How to find your Config ID:</strong><br>
        1. Go to <a href="https://my.nextdns.io" target="_blank">my.nextdns.io</a><br>
        2. Select your <strong>Kids</strong> profile from the dropdown (top left)<br>
        3. Click the <strong>Setup</strong> tab<br>
        4. Find <strong>"ID"</strong> under "Endpoints" â€” that's your Config ID
    </p>

    <label>Blocklist Grade</label>
    <select id="grade">
        <option value="standard">Standard (recommended) - ~600 domains</option>
        <option value="core">Core (minimum) - ~120 domains</option>
        <option value="strict">Strict - ~600+ domains</option>
        <option value="maximum">Maximum - everything</option>
    </select>

    <div class="warning">
        <strong>Important: Use TWO NextDNS profiles</strong><br><br>
        <strong>Kids profile</strong> â†’ Apply Aegis here (blocks GitHub, Vercel, coding sites)<br>
        <strong>Parents profile</strong> â†’ Keep unfiltered for your own devices<br><br>
        If you only have one profile, <a href="https://my.nextdns.io" target="_blank">create a second one</a> before importing. Otherwise you'll block yourself from this tool and other sites you need!
    </div>

    <button id="importBtn" onclick="startImport()">Import to NextDNS</button>

    <div class="progress" id="progress">
        <div class="stats">
            Importing: <span id="current">0</span> / <span id="total">0</span> domains
        </div>
        <div class="progress-bar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        <div class="stats">
            Added: <span id="added">0</span> |
            Skipped (duplicate): <span id="skipped">0</span> |
            Errors: <span id="errors">0</span>
        </div>
        <div id="status"></div>
    </div>

    <script>
        const BLOCKLIST_BASE = 'https://raw.githubusercontent.com/0xDarkMatter/aegis-blocklist/master/grades/';
        const NEXTDNS_API = 'https://api.nextdns.io/profiles';

        // Rate limit: NextDNS allows ~10 req/sec, we'll be conservative
        const DELAY_MS = 150;

        let stats = { added: 0, skipped: 0, errors: 0 };
        let aborted = false;

        async function fetchBlocklist(grade) {
            const url = `${BLOCKLIST_BASE}${grade}.txt`;
            const response = await fetch(url);
            const text = await response.text();
            return text.split('\n')
                .map(line => line.trim())
                .filter(line => line && !line.startsWith('#'));
        }

        async function addDomain(apiKey, configId, domain) {
            const response = await fetch(`${NEXTDNS_API}/${configId}/denylist`, {
                method: 'POST',
                headers: {
                    'X-Api-Key': apiKey,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ id: domain, active: true })
            });

            if (response.status === 409) {
                return 'duplicate';
            } else if (!response.ok) {
                throw new Error(`HTTP ${response.status}`);
            }
            return 'added';
        }

        function updateUI(current, total) {
            document.getElementById('current').textContent = current;
            document.getElementById('total').textContent = total;
            document.getElementById('added').textContent = stats.added;
            document.getElementById('skipped').textContent = stats.skipped;
            document.getElementById('errors').textContent = stats.errors;
            document.getElementById('progressFill').style.width = `${(current / total) * 100}%`;
        }

        async function startImport() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const configId = document.getElementById('configId').value.trim();
            const grade = document.getElementById('grade').value;

            if (!apiKey || !configId) {
                alert('Please enter both API Key and Config ID');
                return;
            }

            const btn = document.getElementById('importBtn');
            const progress = document.getElementById('progress');
            const status = document.getElementById('status');

            btn.disabled = true;
            btn.textContent = 'Importing...';
            progress.style.display = 'block';
            stats = { added: 0, skipped: 0, errors: 0 };
            aborted = false;

            try {
                status.innerHTML = '<span style="color:#8b949e">Fetching blocklist...</span>';
                const domains = await fetchBlocklist(grade);

                status.innerHTML = '<span style="color:#8b949e">Importing domains...</span>';

                for (let i = 0; i < domains.length; i++) {
                    if (aborted) break;

                    const domain = domains[i];
                    try {
                        const result = await addDomain(apiKey, configId, domain);
                        if (result === 'duplicate') {
                            stats.skipped++;
                        } else {
                            stats.added++;
                        }
                    } catch (e) {
                        stats.errors++;
                        console.error(`Failed: ${domain}`, e);
                    }

                    updateUI(i + 1, domains.length);

                    // Small delay to avoid rate limiting
                    if (i < domains.length - 1) {
                        await new Promise(r => setTimeout(r, DELAY_MS));
                    }
                }

                status.innerHTML = `<span class="success">âœ“ Complete! Added ${stats.added} domains to your denylist.</span>`;

            } catch (e) {
                status.innerHTML = `<span class="error">Error: ${e.message}</span>`;
            }

            btn.disabled = false;
            btn.textContent = 'Import to NextDNS';
        }
    </script>
</body>
</html>
